# uniform_cryptoasset_trade_history_csv_ja

## 概要

* このレポジトリでは、日本国内暗号通貨資産取引所が Web 画面経由で取得できる該当利用者の取引履歴の CSV ファイルのフォーマットを記述する。
* また、任意の CSV ファイルがここで規定するフォーマットに準拠しているか否かを検証する Linter と、 実際のサンプル CSV ファイルを用いた推奨事項も記述する。

## 背景と目的

* 従来、日本国内暗号資産取引所からWeb 画面経由で取得できる取引履歴ファイルは、各社ごとにフォーマットが統一されていなかった。
* そのため、利用者は確定申告のための集計作業を各社ごとに実施する必要があり、暗号資産取引サービスを利用するうえでの大きな障害となっていた。
* 本取り組みの目的は、各社が出力する取引履歴の行単位・列単位の書式を統一することにより、確定申告に伴う利用者の集計負担を引き下げることである。

## 提案・質問・アップデートの流れ

* ここで規定するフォーマットについて疑問や訂正事項がある場合、このレポジトリに対して論点ごとに Issue または Pull Request を作成すること。（テンプレート有）
* バージョンの変更は、 [Semantic Versioning](https://semver.org/) に従い、新規 Git tag をつけた時点で更新したものとする。
* 具体的なフォーマットは、下記ファイルにて記述される。
  * 現物取引の場合 ... [`schema_spot.json`](./schema_spot.json)
  * レバレッジ取引の場合 ... [`schema_leverage.json`](./schema_leverage.json)

## 規約の概要

* CSV ファイルの定義は [RFC4180](https://tools.ietf.org/html/rfc4180) に従うものとする。
* CSV ファイルのフォーマットは [W3C: Metadata Vocabulary for Tabular Data](https://www.w3.org/TR/tabular-metadata/) にしたがって、 json 形式で定義する。
* 改行は CRLF(Windows 形式)とする。
* フィールドが `,` (カンマ) `\r\n` (改行)を含む場合、フィールド全体をダブルクオート (`"`) する。フィールド内のダブルクォートは二重のダブルクォートで置き換える `""テキスト""`

### メタデータ

* CSV ファイルのメタデータは、 [W3C の推奨](https://www.w3.org/TR/tabular-metadata/)に基いてテーブルの最上部に `#` をつけたコメント形式で記述する。
* メタデータの一覧
  * `Version` ... 当該 CSV ファイルが従うフォーマットのバージョンを示す。バージョンごとの規約はこのレポジトリ上で同一バージョンのタグをつけたコミットとする。
* サンプル CSV ファイルを参照のこと。

### 列

* 列は、実際にユーザーに対して提示されるデータを示す。現時点で二種類の CSV ファイル形式が規定されている。
  * 現物取引の場合 ... [`schema_spot.json`](./schema_spot.json)
  * レバレッジ取引の場合 ... [`schema_leverage.json`](./schema_leverage.json)

#### 現物取引

* 以下、列ごとの仕様を記述する。
  * 取引日時
    * yy/mm/dd hh:mm:ssの形式で記載
    * 暗号資産売買の場合は約定日時を記載
    * 暗号資産、法定通貨の入出金の場合はシステム登録日を記載（受渡ベース）
  * 取引種別
    1. 購入: 基軸暗号資産での購入
    1. 売却: 基軸暗号資産または法定通貨での売却
    1. 交換: 暗号資産同士の交換
    1. 預入: 暗号資産の外部からの受入
    1. 送付: 暗号資産の外部への送付
    1. 入金: 法定通貨の預け入れ
    1. 出金: 法定通貨の引き出し
    1. 証拠金預入: 証拠金口座への法定通貨の移動
    1. 証拠金引出: 証拠金口座からの法定通貨の移動
    1. 受取』: 交換事業者からユーザーへの暗号資産または法定通貨の送付等
    1. ハードフォーク: ハードフォークにより新規に入手した暗号資産の数量
    1. 貸出: レンディングサービス利用時の暗号資産の貸出
    1. 返済: レンディングサービス利用時の暗号資産の返済
    1. 受取利息: レンディングサービス利用時の利息としての暗号資産の受取
    1. その他: 上記に含まれない取引
  * 取引形態
    * 取引種別が「購入」「売却」「交換」の際に自己または媒介の別を記載
      1. 自己: 交換事業者との相対取引
      1. 媒介: 板取引
  * 通貨ペア
    * 取引種別が「購入」「売却」「交換」の際に『シンボル/（基軸）シンボル』で記載
    * それ以外の取引種別の際には該当するティッカーシンボルを記載
  * 増加通貨名
    * 取引により顧客資産が増加した場合の増加通貨名をティッカーシンボルで記載
  * 増加数量
    * 増加した通貨の増加数量を記載
  * 減少通貨名
    * 取引により顧客資産が減少した場合の減少通貨名をティッカーシンボルで記載
  * 減少数量
    * 減少した通貨の減少数量を記載
  * 約定価格
    * 取引種別が「購入」「売却」「交換」の際の基軸通貨の移動額または移動数量を記載
  * 単価
    * 取引種別が「購入」「売却」「交換」の際に購入、基軸通貨建で、購入、売却、交換する側の通貨1単位あたりの数量・額を記載
  * 手数料通貨
    * 発生した手数料の通貨名をティッカーシンボルで記載
  * 手数料数量
    * 手数料により減少した通貨の減少数量を記載
  * 送付元アドレス
    * 送付元のアドレスを記載
  * 送付先アドレス
    * 送付先のアドレスを記載
  * 登録番号
    * 暗号資産交換業者登録番号を、関東 / 近畿の別に「関東00001」「近畿00001」の形式で記載
  * 社名
    * 社名を記載
  * 備考
    * キャンペーンボーナスにより暗号資産または法定通貨を付与した場合は発生原因を記載
    * その他特別な事象により暗号資産または法定通貨が移動した場合は発生原因を記載
* [現物取引サンプル](./sample/sample_spot.csv)

#### レバレッジ取引

* 以下、列ごとの仕様を記述する。
  * 取引日時
    * yy/mm/dd hh:mm:ssの形式で記載
    * レバレッジ取引は約定日時を記載
    * 暗号資産、法定通貨の入出金の場合はシステム登録日を記載（受渡ベース）
  * 取引種別
    1. 新規: 新規注文
    1. 決済: 建玉のクローズ取引
    1. 証拠金受入: 現物口座から証拠金口座への法定通貨の移動
    1. 証拠金引出: 証拠金口座からの法定通貨の移動
    1. その他: 上記に含まれない取引
  * 取引形態
    * 取引種別が「新規」「決済」の際に自己または媒介の別を記載
      1. 自己: 交換事業者との相対取引
      1. 媒介: 板取引
  * 通貨ペア
    * 取引種別が「新規」「決済」の際に『シンボル/（基軸）シンボル』で記載
    * それ以外の取引種別の際には該当するティッカーシンボルを記載
  * 売り又は買いの別
    * 取引種別が「新規」「決済」の際に売り注文か買い注文の別を記載
  * 約定数量
    * 取引種別が「新規」「決済」の際に約定した約定数量
  * 約定価格
    * 取引種別が「新規」「決済」の際に約定した注文の約定価格
  * 約定金額
    * 取引種別が「新規」「決済」の際に約定した注文の約定金額
  * 手数料通貨
    * 取引手数料が発生した際の手数料通貨名をティッカーシンボルで記載
  * 手数料数量
    * 取引手数料が発生した際の手数料数量を記載
  * 入金・出金
    * レバレッジ口座からの法定通貨・暗号資産の預け入れまたは引き出し数量を記載
  * 決済損益
    * 取引種別『決済』の際に発生する決済損益を円貨建てで記載
  * レバレッジ手数料
    * 建玉管理手数料等を記載
  * 預託JPY
    * 取引発生時において預託されている日本円残高を記載
  * 預託BTC
    * 取引発生時において預託されているBTC残高を記載（他の暗号資産が預託されている場合にはカラムを増やす）
  * 約定番号
    * 取引種別が「新規」「決済」の際に付された約定番号を記載
  * 登録番号
    * 暗号資産交換業者登録番号を、関東 / 近畿の別に「関東00001」「近畿00001」の形式で記載
  * 社名
    * 社名を記載
  * 備考
    * キャンペーンボーナスにより暗号資産または法定通貨を付与した場合は発生原因を記載
    * その他特別な事象により暗号資産または法定通貨が移動した場合は発生原因を記載
* [レバレッジ取引サンプル](./sample/sample_leverage.csv)

## csvlint の実行方法

* Unix 環境 (Mac, Linux, etc.) を想定。
* 予め、Docker をインストールしておくこと。
* 任意の csv ファイルがこのレポジトリで指定する規約にしたがっていることを確認するため、[csvlint](https://github.com/Data-Liberation-Front/csvlint.rb) による validation を実行できる。手順は以下
* 作業はこのレポジトリの root ディレクトリで行うものとする。
* 事前に root ディレクトリに対象の CSV をコピーする。
  * 命名は下記のとおり。
    * 現物: `spot.csv`
    * レバレッジ: `leverage.csv`

```sh
# 現物取引の csv validate
cp <対象ファイル> ./spot.csv
./validate_spot.sh

# レバレッジ取引の csv validate
cp <対象ファイル> ./leverage.csv
./validate_leverage.sh
```

## 追加のリソース

* [csvlint](https://github.com/Data-Liberation-Front/csvlint.rb)
